<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="uirouter-behavior.html">

<!--
`uirouter-sref`
Element that generates `<a>` tag with contents.

For links with custom attributes for state params you should be using `property-foo$=[[value]]` notation.

@demo demo/demo-sref.html uirouter-sref element demo
-->

<script>
    (function () {

        Polymer({

            is: 'uirouter-sref',
            behaviors: [
                UIRouterBehavior
            ],
            properties: {
                /** The name of the state to link to */
                state: {
                    type:String,
                    observer: '_updateState'
                },
                /** Sets whether or not the transition's parameter values should be inherited from the current parameter values. */
                inherit: {
                    type: Boolean,
                    value: false
                },
                /** your own Transition Options inside this property and use them, e.g., from a Transition Hook  */
                custom: {
                    type: Object,
                    value: null
                },
                /** Changes how the Transition interacts with the browser's location bar */
                noLocation: {
                    type: Boolean,
                    value: false
                },
                /** force states which are currently active to reload */
                reload: {
                    type: Boolean,
                    value: false
                },
                /** When transitioning to relative path (e.g '^'),
                 * this option defines which state to be relative from.  */
                relative: {
                    type: String,
                    value: '$state.current'
                },
                linkRel: String,
                linkTarget: String,
                /** The parameter values to use (as key/values) */
                params: {
                    type: Object,
                    value: null,
                    observer: '_updateParams'
                },
                /** compiled params */
                _params: {
                    type: Object,
                    value: null
                },
                /**
                 * Link url generated by this element
                 */
                generatedURL: {
                    type: String,
                    notify: true
                },
                /**
                 * Time that (in ms) url generator should debounce before generating url
                 */
                debounceTime: {
                    type: Number,
                    value: 0
                }
            },
            _toCamelCase: function (input) {
                output = input[0].toUpperCase() + input.slice(1);
                return output;
            },
            getParams: function () {
                var params = this.params || {};
                for (var x = 0; x < this.attributes.length; x++) {
                    var item = this.attributes[x];
                    if (item.name.indexOf('param-') === 0) {
                        var name = item.name.slice(6);
                        var segments = name.split('-');
                        name = segments[0] + segments.slice(1).map(this._toCamelCase).join('');
                        params[name] = item.value;
                    }
                }
                this._params = params;
                return params;
            },

            // notify sref-active elements that their children properties
            _updateParams: function(newValue, oldValue){
                if(!this.state || typeof newValue ==='undefined' || typeof oldValue ==='undefined' ){
                    return
                }
                this.fire('uirouter-sref-detached', {state: this.state, params: oldValue});
                this.fire('uirouter-sref-attached', {state: this.state, params: newValue});
                this.computeLink();
            },
            _updateState: function(newValue, oldValue){
                if(!this.state || typeof newValue ==='undefined' || typeof oldValue ==='undefined' ){
                    return
                }

                this.fire('uirouter-sref-detached', {state: oldValue, params: this._params});
                this.fire('uirouter-sref-attached', {state: this.state, params: this._params});
                this.computeLink();
            },

            attached: function () {
                this.computeLink();
                this.fire('uirouter-sref-attached', {state: this.state, params: this._params});
                this.listen(this, 'click', 'handleClick');
                this._observer = new MutationObserver(function(mutations) {
                    this._computeLink();
                }.bind(this));
                this._observer.observe(this, {attributes: true});
            },

            detached: function () {
                this.fire('uirouter-sref-detached', {state: this.state, params: this._params});
                this.unlisten(this, 'click', 'handleClick');
                this._observer.disconnect();
            },

            computeLink: function () {
                if (this.debounceTime > 0) {
                    this.debounce('computeLink', this._computeLink, this.debounceTime);
                }
                else {
                    this._computeLink();
                }
            },

            _assembleOptions: function () {
                return {
                    inherit: this.inherit,
                    custom: this.custom,
                    location: !this.noLocation,
                    relative: this.relative,
                    reload: this.reload
                };
            },

            _computeLink: function () {
                var params = this.getParams();
                this.generatedURL = this.uiRouter.stateService.href(this.state, params, this._assembleOptions());
                this._updateMarkup();
            },

            _updateMarkup: function(){
                var slottedNodes = Polymer.dom(this).getEffectiveChildNodes();
                // when updating the element the node might already wrap with A tag, so get the children
                if (slottedNodes.length === 1 && Node.ELEMENT_NODE == slottedNodes[0].nodeType &&
                    slottedNodes[0].classList.contains("uirouter-link")){
                    slottedNodes = slottedNodes[0].childNodes;
                }
                while (this.hasChildNodes()) {
                    this.removeChild(this.lastChild);
                }
                var link = document.createElement('a');
                link.className = 'uirouter-link';
                link.href = this.generatedURL;
                if(this.linkTarget){
                    link.target = this.linkTarget;
                }
                if(this.linkRel){
                    link.rel = this.linkRel;
                }
                for(var i=0; i< slottedNodes.length; i++){
                    link.appendChild(slottedNodes[i]);
                }
                this.appendChild(link);
            },

            handleClick: function (event) {
                if (!event.defaultPrevented && !(event.shiftKey || event.metaKey || event.ctrlKey)) {
                    event.preventDefault();
                    var params = this.getParams();
                    this.uiRouter.stateService.go(this.state, params, this._assembleOptions());
                }
            }

        });

    })()


</script>
